{"ast":null,"code":"import React from\"react\";import{base44}from\"@/api/base44Client\";import{useQuery}from\"@tanstack/react-query\";import{MessageSquare,Clock}from\"lucide-react\";import{Link}from\"react-router-dom\";import{createPageUrl}from\"@/utils\";import{format}from\"date-fns\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";export default function ChatList(){const{data:user}=useQuery({queryKey:['currentUser'],queryFn:()=>base44.auth.me()});const{data:messages,isLoading}=useQuery({queryKey:['allMessages',user===null||user===void 0?void 0:user.email],queryFn:async()=>{if(!(user!==null&&user!==void 0&&user.email))return[];const sent=await base44.entities.ChatMessage.filter({sender_email:user.email},'-created_date',100);const received=await base44.entities.ChatMessage.filter({receiver_email:user.email},'-created_date',100);return[...sent,...received];},enabled:!!(user!==null&&user!==void 0&&user.email),refetchInterval:30000,// Add 30 second refetch\nstaleTime:20000,initialData:[]});// Group by conversation\nconst conversations=React.useMemo(()=>{const convMap=new Map();messages.forEach(msg=>{const conversationId=msg.conversation_id;if(!convMap.has(conversationId)){const otherEmail=msg.sender_email===(user===null||user===void 0?void 0:user.email)?msg.receiver_email:msg.sender_email;convMap.set(conversationId,{conversationId,otherEmail,lastMessage:msg,unreadCount:0,messages:[]});}const conv=convMap.get(conversationId);conv.messages.push(msg);if(msg.receiver_email===(user===null||user===void 0?void 0:user.email)&&!msg.is_read){conv.unreadCount++;}if(new Date(msg.created_date)>new Date(conv.lastMessage.created_date)){conv.lastMessage=msg;}});return Array.from(convMap.values()).sort((a,b)=>new Date(b.lastMessage.created_date)-new Date(a.lastMessage.created_date));},[messages,user]);return/*#__PURE__*/_jsxs(\"div\",{className:\"max-w-4xl mx-auto space-y-6\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"text-center\",children:[/*#__PURE__*/_jsx(\"h1\",{className:\"text-5xl font-black text-white neon-text uppercase tracking-tight\",style:{color:\"#00FF41\"},children:\"MESSAGES\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-xl font-bold text-white mt-2\",children:\"YOUR CONVERSATIONS\"})]}),isLoading?/*#__PURE__*/_jsx(\"div\",{className:\"text-center py-12\",children:/*#__PURE__*/_jsx(\"div\",{className:\"inline-block w-12 h-12 border-4 border-[#00FF41] border-t-[#FF0080] rounded-full animate-spin\"})}):conversations.length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"brutalist-card p-12 text-center\",children:[/*#__PURE__*/_jsx(MessageSquare,{className:\"w-16 h-16 mx-auto mb-4 text-black\"}),/*#__PURE__*/_jsx(\"h3\",{className:\"text-2xl font-black text-black uppercase\",children:\"NO MESSAGES YET\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-black font-bold mt-2\",children:\"START A CONVERSATION!\"})]}):/*#__PURE__*/_jsx(\"div\",{className:\"space-y-4\",children:conversations.map((conv,index)=>/*#__PURE__*/_jsx(Link,{to:createPageUrl(\"Chat?with=\".concat(encodeURIComponent(conv.otherEmail))),className:\"brutalist-card p-6 block hover:translate-x-1 hover:translate-y-1 transition-all\",style:{transform:index%2!==0?'rotate(0.5deg)':'rotate(-0.5deg)'},children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-start justify-between\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex-1\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center gap-3 mb-2\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"w-12 h-12 bg-gradient-to-br from-[#FF0080] to-[#B026FF] rounded-full border-3 border-black flex items-center justify-center\",children:/*#__PURE__*/_jsx(\"span\",{className:\"text-xl font-black text-white\",children:conv.otherEmail[0].toUpperCase()})}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-xl font-black text-black uppercase\",children:conv.otherEmail.split('@')[0]}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm font-bold text-gray-600\",children:conv.otherEmail})]})]}),/*#__PURE__*/_jsx(\"p\",{className:\"text-black font-bold ml-15 line-clamp-2\",children:conv.lastMessage.message})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"text-right flex flex-col items-end gap-2\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center gap-2 text-sm font-bold text-black\",children:[/*#__PURE__*/_jsx(Clock,{className:\"w-4 h-4\"}),format(new Date(conv.lastMessage.created_date),\"MMM d, h:mm a\")]}),conv.unreadCount>0&&/*#__PURE__*/_jsx(\"span\",{className:\"w-8 h-8 bg-[#FF0080] text-white text-sm font-black flex items-center justify-center rounded-full border-3 border-black online-pulse\",children:conv.unreadCount})]})]})},conv.conversationId))})]});}","map":{"version":3,"names":["React","base44","useQuery","MessageSquare","Clock","Link","createPageUrl","format","jsx","_jsx","jsxs","_jsxs","ChatList","data","user","queryKey","queryFn","auth","me","messages","isLoading","email","sent","entities","ChatMessage","filter","sender_email","received","receiver_email","enabled","refetchInterval","staleTime","initialData","conversations","useMemo","convMap","Map","forEach","msg","conversationId","conversation_id","has","otherEmail","set","lastMessage","unreadCount","conv","get","push","is_read","Date","created_date","Array","from","values","sort","a","b","className","children","style","color","length","map","index","to","concat","encodeURIComponent","transform","toUpperCase","split","message"],"sources":["/workspace/BigGrade-Main-files/src/pages/ChatList.jsx"],"sourcesContent":["\nimport React from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { MessageSquare, Clock } from \"lucide-react\";\nimport { Link } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { format } from \"date-fns\";\n\nexport default function ChatList() {\n  const { data: user } = useQuery({\n    queryKey: ['currentUser'],\n    queryFn: () => base44.auth.me(),\n  });\n\n  const { data: messages, isLoading } = useQuery({\n    queryKey: ['allMessages', user?.email],\n    queryFn: async () => {\n      if (!user?.email) return [];\n      const sent = await base44.entities.ChatMessage.filter({ sender_email: user.email }, '-created_date', 100);\n      const received = await base44.entities.ChatMessage.filter({ receiver_email: user.email }, '-created_date', 100);\n      return [...sent, ...received];\n    },\n    enabled: !!user?.email,\n    refetchInterval: 30000, // Add 30 second refetch\n    staleTime: 20000,\n    initialData: [],\n  });\n\n  // Group by conversation\n  const conversations = React.useMemo(() => {\n    const convMap = new Map();\n    \n    messages.forEach(msg => {\n      const conversationId = msg.conversation_id;\n      if (!convMap.has(conversationId)) {\n        const otherEmail = msg.sender_email === user?.email ? msg.receiver_email : msg.sender_email;\n        convMap.set(conversationId, {\n          conversationId,\n          otherEmail,\n          lastMessage: msg,\n          unreadCount: 0,\n          messages: []\n        });\n      }\n      \n      const conv = convMap.get(conversationId);\n      conv.messages.push(msg);\n      \n      if (msg.receiver_email === user?.email && !msg.is_read) {\n        conv.unreadCount++;\n      }\n      \n      if (new Date(msg.created_date) > new Date(conv.lastMessage.created_date)) {\n        conv.lastMessage = msg;\n      }\n    });\n    \n    return Array.from(convMap.values()).sort((a, b) => \n      new Date(b.lastMessage.created_date) - new Date(a.lastMessage.created_date)\n    );\n  }, [messages, user]);\n\n  return (\n    <div className=\"max-w-4xl mx-auto space-y-6\">\n      {/* Header */}\n      <div className=\"text-center\">\n        <h1 className=\"text-5xl font-black text-white neon-text uppercase tracking-tight\" style={{ color: \"#00FF41\" }}>\n          MESSAGES\n        </h1>\n        <p className=\"text-xl font-bold text-white mt-2\">\n          YOUR CONVERSATIONS\n        </p>\n      </div>\n\n      {/* Conversations List */}\n      {isLoading ? (\n        <div className=\"text-center py-12\">\n          <div className=\"inline-block w-12 h-12 border-4 border-[#00FF41] border-t-[#FF0080] rounded-full animate-spin\"></div>\n        </div>\n      ) : conversations.length === 0 ? (\n        <div className=\"brutalist-card p-12 text-center\">\n          <MessageSquare className=\"w-16 h-16 mx-auto mb-4 text-black\" />\n          <h3 className=\"text-2xl font-black text-black uppercase\">NO MESSAGES YET</h3>\n          <p className=\"text-black font-bold mt-2\">START A CONVERSATION!</p>\n        </div>\n      ) : (\n        <div className=\"space-y-4\">\n          {conversations.map((conv, index) => (\n            <Link\n              key={conv.conversationId}\n              to={createPageUrl(`Chat?with=${encodeURIComponent(conv.otherEmail)}`)}\n              className=\"brutalist-card p-6 block hover:translate-x-1 hover:translate-y-1 transition-all\"\n              style={{\n                transform: index % 2 !== 0 ? 'rotate(0.5deg)' : 'rotate(-0.5deg)'\n              }}\n            >\n              <div className=\"flex items-start justify-between\">\n                <div className=\"flex-1\">\n                  <div className=\"flex items-center gap-3 mb-2\">\n                    <div className=\"w-12 h-12 bg-gradient-to-br from-[#FF0080] to-[#B026FF] rounded-full border-3 border-black flex items-center justify-center\">\n                      <span className=\"text-xl font-black text-white\">\n                        {conv.otherEmail[0].toUpperCase()}\n                      </span>\n                    </div>\n                    <div>\n                      <h3 className=\"text-xl font-black text-black uppercase\">\n                        {conv.otherEmail.split('@')[0]}\n                      </h3>\n                      <p className=\"text-sm font-bold text-gray-600\">\n                        {conv.otherEmail}\n                      </p>\n                    </div>\n                  </div>\n                  <p className=\"text-black font-bold ml-15 line-clamp-2\">\n                    {conv.lastMessage.message}\n                  </p>\n                </div>\n                <div className=\"text-right flex flex-col items-end gap-2\">\n                  <div className=\"flex items-center gap-2 text-sm font-bold text-black\">\n                    <Clock className=\"w-4 h-4\" />\n                    {format(new Date(conv.lastMessage.created_date), \"MMM d, h:mm a\")}\n                  </div>\n                  {conv.unreadCount > 0 && (\n                    <span className=\"w-8 h-8 bg-[#FF0080] text-white text-sm font-black flex items-center justify-center rounded-full border-3 border-black online-pulse\">\n                      {conv.unreadCount}\n                    </span>\n                  )}\n                </div>\n              </div>\n            </Link>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}